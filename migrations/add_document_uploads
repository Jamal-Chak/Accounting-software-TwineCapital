-- Document uploads and OCR tracking

CREATE TABLE IF NOT EXISTS document_uploads (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    
    -- File details
    file_name VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    file_type VARCHAR(50) NOT NULL, -- 'image/jpeg', 'image/png', 'application/pdf'
    file_size INTEGER,
    
    -- OCR status
    ocr_status VARCHAR(50) NOT NULL DEFAULT 'pending', -- 'pending', 'processing', 'completed', 'failed'
    raw_text TEXT,
    extracted_data JSONB,
    confidence_score DECIMAL(3,2),
    
    -- Processing timestamps
    processed_at TIMESTAMP WITH TIME ZONE,
    
    -- Linked expense (if auto-posted)
    expense_id UUID REFERENCES expenses(id),
    
    -- Status
    review_status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
    reviewed_by UUID REFERENCES auth.users(id),
    reviewed_at TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- OCR corrections for learning
CREATE TABLE IF NOT EXISTS ocr_corrections (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    document_id UUID NOT NULL REFERENCES document_uploads(id) ON DELETE CASCADE,
    
    field_name VARCHAR(50) NOT NULL, -- 'vendor', 'date', 'amount', etc.
    original_value TEXT,
    corrected_value TEXT NOT NULL,
    
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_document_uploads_company ON document_uploads(company_id);
CREATE INDEX IF NOT EXISTS idx_document_uploads_status ON document_uploads(ocr_status);
CREATE INDEX IF NOT EXISTS idx_document_uploads_review ON document_uploads(review_status);
CREATE INDEX IF NOT EXISTS idx_document_uploads_created ON document_uploads(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_ocr_corrections_document ON ocr_corrections(document_id);
CREATE INDEX IF NOT EXISTS idx_ocr_corrections_field ON ocr_corrections(field_name);

-- Updated at trigger
CREATE OR REPLACE FUNCTION update_document_uploads_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER document_uploads_updated_at
    BEFORE UPDATE ON document_uploads
    FOR EACH ROW
    EXECUTE FUNCTION update_document_uploads_updated_at();

-- RLS Policies
ALTER TABLE document_uploads ENABLE ROW LEVEL SECURITY;
ALTER TABLE ocr_corrections ENABLE ROW LEVEL SECURITY;

CREATE POLICY document_uploads_select ON document_uploads
    FOR SELECT USING (auth.uid() IN (
        SELECT user_id FROM company_users WHERE company_id = document_uploads.company_id
    ));

CREATE POLICY document_uploads_insert ON document_uploads
    FOR INSERT WITH CHECK (auth.uid() IN (
        SELECT user_id FROM company_users WHERE company_id = document_uploads.company_id
    ));

CREATE POLICY document_uploads_update ON document_uploads
    FOR UPDATE USING (auth.uid() IN (
        SELECT user_id FROM company_users WHERE company_id = document_uploads.company_id
    ));

CREATE POLICY document_uploads_delete ON document_uploads
    FOR DELETE USING (auth.uid() IN (
        SELECT user_id FROM company_users WHERE company_id = document_uploads.company_id
    ));

-- OCR corrections policies
CREATE POLICY ocr_corrections_select ON ocr_corrections
    FOR SELECT USING (auth.uid() IN (
        SELECT user_id FROM company_users cu
        JOIN document_uploads du ON du.company_id = cu.company_id
        WHERE du.id = ocr_corrections.document_id
    ));

CREATE POLICY ocr_corrections_insert ON ocr_corrections
    FOR INSERT WITH CHECK (auth.uid() IN (
        SELECT user_id FROM company_users cu
        JOIN document_uploads du ON du.company_id = cu.company_id
        WHERE du.id = ocr_corrections.document_id
    ));
